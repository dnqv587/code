#include <stdio.h>
#include <graphics.h>//图形库
#include <conio.h>///控制台输入输出
#include <string.h>
#include <mmsystem.h>//多媒体设备接口
#include <windows.h>//调用系统api
#include "sqStack.h"//顺序栈
#pragma comment(lib,"winmm.lib")//加载静态库
#pragma warning(disable:4996)//屏蔽关于strcpy的警告

#include "sqQueue.h"

int state[20][20][20][20];//存储人和箱子的位置状态
int stepN = 0;//存储寻路的步数
int moves[4][2] = { {0,1},{0,-1},{-1,0},{1,0} };//右 左 上 下
char dir[100];//存储方向
sqQueue qq;//定义一个队列结构
sqQueue bb;


IMAGE img[9];
int imgIndex[9] = { 0,1,2,3,4,5,6,7,9 };//0:空地，1：墙，2：人物向左3：目的地，4：箱子，5：人物向下，6：人物向右7：箱子到达目的地，8：站在目的地上的人物，9：人物向上
int level = 0;//关卡
char userkey = ' ';//用户键值
char times[40] = "";//当前用时
char putLevel[40] = "";//输出关卡
char putStep[20] = "";//输出步数
int screenX = GetSystemMetrics(SM_CXSCREEN);//获取屏幕横向分辨率
int screenY = GetSystemMetrics(SM_CYSCREEN);//获取屏幕纵向分辨率
int step = 0;//步数
int timerFlag = 1;//子线程计时器退出标识
int labelFlag = 1;//标签刷新标识
int musicFlag = 1;//音乐播放标识
int dispplayFlag = 0;//标签显示标识
int BGM_N = 1;//音乐名称序号
int nVolume = 300;//音量
int hour = 0, minute = 0, second = 1;//时间
sqStack ss;//定义一个栈
int map[20][20];//存储当前使用地图

struct attribute //按钮结构体
{
	int x;//按钮横坐标
	int y;//按钮纵坐标
	int width;//宽度
	int height;//高度
	COLORREF color;//颜色
	char* pText;//标签
};


struct Point//地图大小控制
{
	int x, y;
};
Point point[] =
{
	{8,8},{9,9},{7,10},{8,6},{8,8},{11,13},{8,10},{7,10},{9,11},{8,7},{6,12},{7,8},{13,10},{7,8},{7,8},{9,10},{7,9},{9,10},
	{8,10},{8,7},{8,11},{9,9},{8,10},{9,14},{10,11},{12,13},{12,15},{13,16},{7,9},{7,12},{8,9},{8,8},{12,14},{13,15},{10,10},
	{12,15},{8,9},{12,12},{10,11},{7,7}
};

int maps[40][16][16] =  //总地图
{
	{
	   {0,0,1,1,1,0,0,0},{0,0,1,3,1,0,0,0},{0,0,1,0,1,1,1,1},{1,1,1,4,0,4,3,1},
	   {1,3,0,4,5,1,1,1},{1,1,1,1,4,1,0,0},{0,0,0,1,3,1,0,0},{0,0,0,1,1,1,0,0}
	},
	{
	{1,1,1,1,1,0,0,0,0},{1,0,0,5,1,0,0,0,0},{1,0,0,4,1,0,0,0,0},{1,0,4,0,1,0,1,1,1},
	{1,1,1,0,1,1,1,3,1},{0,1,1,0,0,0,0,3,1},{0,1,0,0,0,1,0,0,1},{0,1,0,0,0,1,1,1,1},{0,1,1,1,1,1,0,0,0}
	},
	{
	{0,1,1,1,1,1,1,1,0,0},{0,1,0,0,0,0,0,1,1,1},{1,1,0,1,1,1,0,4,0,1},{1,5,0,0,4,0,0,0,0,1},
	{1,0,3,3,1,0,4,0,1,1},{1,1,1,3,1,0,0,0,1,0},{0,0,1,1,1,1,1,1,1,0}
	},
	{
	{0,1,1,1,1,0},{1,1,0,0,1,0},{1,5,0,4,1,0},{1,1,0,0,1,1},
	{1,1,0,4,0,1},{1,3,4,0,0,1},{1,3,3,0,0,1},{1,1,1,1,1,1}
	},
	{
	    {0,1,1,1,1,1,0,0},{0,1,0,0,1,1,1,0},{0,1,0,0,0,0,1,0},{1,1,1,4,1,0,1,1},
	    {1,3,1,0,1,0,0,1},{1,3,4,0,0,1,0,1},{1,3,0,4,0,0,5,1},{1,1,1,1,1,1,1,1}
	},
	{
		{0,0,0,1,1,1,1,1,1,1,0,0,0},{1,1,1,1,0,0,0,0,0,1,0,0,0},{1,0,0,0,3,1,1,1,0,1,0,0,0},{1,0,1,0,1,0,0,0,0,1,1,0,0},{1,0,1,0,4,0,4,1,3,0,1,0,0},
	    {1,0,1,0,0,5,0,0,1,0,1,0,0},{1,0,3,1,4,0,4,0,1,0,1,0,0},{1,1,0,0,0,0,1,0,1,0,1,1,1},{0,1,0,1,1,1,3,0,0,0,0,0,1},{0,1,0,0,0,0,0,1,1,0,0,0,1},{0,1,1,1,1,1,1,1,1,1,1,1,1}
	},
	{
		{0,0,0,1,1,1,1,1,1,1},{0,0,1,1,0,0,1,0,5,1},{0,0,1,0,0,0,1,4,0,1},{0,0,1,4,0,0,4,0,0,1},
		{0,0,1,0,4,1,1,0,0,1},{1,1,1,0,4,0,1,0,1,1},{1,3,3,3,3,3,0,0,1,0},{1,1,1,1,1,1,1,1,1,0}
	},
	{
		 {0,0,0,1,1,1,1,1,1,0},{0,1,1,1,0,0,0,0,1,0},{1,1,3,0,4,1,1,0,1,1},{1,3,3,4,0,4,0,0,5,1},
		 {1,3,3,0,4,0,4,0,1,1},{1,1,1,1,1,1,0,0,1,0},{0,0,0,0,0,1,1,1,1,0}
	},
	{
		{0,1,1,1,1,1,1,1,1,1,0},{0,1,0,0,1,1,0,0,0,1,0},{0,1,0,0,0,4,0,0,0,1,0},{0,1,4,0,1,1,1,0,4,1,0},
		{0,1,0,1,3,3,3,1,0,1,0},{1,1,0,1,3,3,3,1,0,1,1},{1,0,4,0,0,4,0,0,4,0,1},{1,0,0,0,0,0,1,0,0,5,1},{1,1,1,1,1,1,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,1},{1,3,3,4,3,3,1},{1,3,3,1,3,3,1},{1,0,4,4,4,0,1},{1,0,0,4,0,0,1},{1,0,4,4,4,0,1},
		{1,0,0,1,0,5,1},{1,1,1,1,1,1,1}
	},
	{
		{0,1,1,1,1,0,0,1,1,1,1,1},{1,1,0,0,1,0,0,1,0,0,0,1},{1,0,4,0,1,1,1,1,4,0,0,1},{1,0,0,4,3,3,3,3,0,4,0,1},
		{1,1,0,0,0,0,1,0,5,0,1,1},{0,1,1,1,1,1,1,1,1,1,1,0}
	},
	{
		{0,0,1,1,1,1,1,0},{1,1,1,0,0,5,1,0},{1,0,0,4,3,0,1,1},{1,0,0,3,4,3,0,1},{1,1,1,0,7,4,0,1},{0,0,1,0,0,0,1,1},
		{0,0,1,1,1,1,1,0}
	},
	{
		{0,0,1,1,1,1,1,1,1,0},{0,1,1,0,0,0,0,0,1,1},{0,1,0,4,0,0,4,3,0,1},{1,1,0,0,1,1,3,4,0,1},{1,0,0,4,5,1,4,3,0,1},
		{1,0,0,0,1,1,3,4,1,1},{1,1,1,4,1,0,4,3,0,1},{0,1,0,0,3,0,1,1,0,1},{0,1,0,0,0,0,1,0,0,1},{0,1,1,3,0,1,1,0,1,1},{0,0,1,1,3,1,0,0,1,0},
		{0,0,0,1,0,0,0,1,1,0},{0,0,0,1,1,1,1,1,0,0}
	},
	{
		{1,1,1,1,1,1,1,1},{1,0,0,1,0,0,0,1},{1,0,4,3,3,4,0,1},{1,5,4,3,7,0,1,1},{1,0,4,3,3,4,0,1},
		{1,0,0,1,0,0,0,1},{1,1,1,1,1,1,1,1}
	},
	{
		{0,1,1,1,1,1,1,0},{1,1,0,0,0,0,1,1},{1,0,4,0,4,4,0,1},{1,3,3,3,3,3,3,1},{1,0,4,4,0,4,0,1},
		{1,1,1,0,5,1,1,1},{0,0,1,1,1,1,0,0}
	},
	{
		{0,0,1,1,1,1,1,1,1,1},{0,0,1,0,0,0,0,1,1,1},{0,0,1,0,4,0,0,0,0,1},{1,1,1,0,4,0,1,1,0,1},{1,3,3,3,0,4,0,0,0,1},
		{1,3,3,3,4,1,4,0,1,1},{1,1,1,1,0,1,0,4,0,1},{0,0,0,1,0,0,0,5,0,1},{0,0,0,1,1,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,0,0,0},{1,0,0,0,0,1,0,0,0},{1,0,4,4,4,1,1,0,0},{1,0,0,1,3,3,1,1,1},{1,1,0,0,3,3,4,0,1},
		{0,1,0,0,5,0,0,0,1},{0,1,1,1,1,1,1,1,1}
	},
	{
		{0,0,1,1,1,1,1,1,1,1},{0,0,1,0,0,0,1,3,0,1},{0,1,1,0,0,4,3,3,3,1},{0,1,0,0,4,0,1,7,3,1},
		{1,1,0,1,1,4,1,0,1,1},{1,0,0,0,4,0,0,4,0,1},{1,0,0,0,1,0,0,0,0,1},{1,1,1,1,1,1,1,5,0,1},{0,0,0,0,0,0,1,1,1,1}
	},
	{
		{0,1,1,1,1,1,1,1,0,0},{0,1,3,3,3,3,0,1,0,0},{1,1,1,3,3,3,4,1,1,1},{1,0,0,4,1,4,0,4,0,1},
		{1,0,4,4,0,0,1,4,0,1},{1,0,0,0,0,1,0,0,0,1},{1,1,1,1,0,5,0,1,1,1},{0,0,0,1,1,1,1,1,0,0}
	},
	{
		{1,1,1,1,1,1,1},{1,3,3,4,3,3,1},{1,3,3,1,3,3,1},{1,0,4,4,4,0,1},{1,0,0,4,0,0,1},{1,0,4,4,4,0,1},
		{1,0,0,1,5,0,1},{1,1,1,1,1,1,1}
	},
	{
		{0,0,0,1,1,1,1,1,1,0,0},{0,0,0,1,0,3,3,3,1,0,0},{1,1,1,1,3,3,3,3,1,0,0},{1,0,0,1,1,1,4,0,1,1,1},
		{1,0,4,0,4,0,0,4,4,0,1},{1,5,0,4,0,4,0,0,0,0,1},{1,0,0,0,1,1,1,0,0,0,1},{1,1,1,1,1,0,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,1,1,0},{1,0,0,0,0,0,0,1,0},{1,0,1,4,4,0,0,1,0},{1,0,3,3,3,1,0,1,0},{1,1,3,3,3,4,0,1,1},
		{0,1,0,1,1,0,4,0,1},{0,1,4,0,0,4,0,0,1},{0,1,0,0,1,0,0,5,1},{0,1,1,1,1,1,1,1,1}
	},
	{
		{0,0,1,1,1,1,1,0,0,0},{1,1,1,0,0,0,1,1,1,1},{1,0,0,0,4,0,0,4,0,1},{1,0,4,0,5,4,0,0,0,1},{1,1,1,4,4,1,1,1,1,1},
		{0,0,1,0,0,3,3,1,0,0},{0,0,1,3,3,3,3,1,0,0},{0,0,1,1,1,1,1,1,0,0}
	},
	{
		{1,1,1,1,1,1,0,0,0,1,1,1,1,1},{1,0,0,0,0,1,1,1,0,1,0,0,0,1},{1,0,0,4,0,4,0,1,0,1,3,3,3,1},
		{1,0,1,0,0,4,0,1,1,1,0,0,3,1},{1,0,0,4,4,4,0,0,0,4,0,5,3,1},{1,1,1,0,0,4,0,0,4,1,0,0,3,1},{0,0,1,0,0,4,1,4,0,1,3,3,3,1},
		{0,0,1,1,0,0,0,0,0,1,0,0,3,1},{0,0,0,1,1,1,1,1,1,1,1,1,1,1}
	},
	{
		{0,0,0,0,0,1,1,1,1,1,1},{0,1,1,1,1,1,3,0,0,0,1},{0,1,0,0,1,3,3,1,1,0,1},{0,1,0,0,4,3,3,0,0,0,1},
		{0,1,0,0,1,0,3,1,0,1,1},{1,1,1,0,1,1,4,1,0,0,1},{1,0,4,0,0,0,0,4,4,0,1},{1,0,1,4,1,0,0,1,0,0,1},{1,5,0,0,1,1,1,1,1,1,1},
		{1,1,1,1,1,0,0,0,0,0,0}
	},
	{
		{0,1,1,1,1,1,1,1,1,1,0,0,0},{0,1,0,0,0,1,1,0,0,1,1,1,1},{0,1,0,4,0,0,0,0,0,0,0,0,1},{0,1,1,4,1,1,1,0,1,1,0,0,1},
		{0,1,0,0,1,1,0,7,0,1,0,1,1},{0,1,0,4,3,3,3,3,3,3,0,1,0},{1,1,0,1,1,1,0,3,0,1,0,1,0},{1,0,0,0,0,0,4,1,1,1,4,1,0},
		{1,0,0,0,1,0,0,0,0,4,5,1,0},{1,1,1,1,1,4,1,0,1,1,1,1,0},{0,0,0,0,1,0,0,0,1,0,0,0,0},{0,0,0,0,1,1,1,1,1,0,0,0,0}
	},
	{
		{0,0,0,0,0,0,1,1,1,1,1,1,1,1,1},{0,0,0,0,0,0,1,0,0,0,0,0,0,0,1},{0,0,0,0,0,0,1,0,1,0,1,0,1,0,1},
		{0,0,0,0,0,0,1,0,0,4,0,4,1,0,1},{1,1,1,1,1,1,1,0,0,0,4,0,0,0,1},{1,3,3,1,0,0,1,1,0,4,0,4,1,0,1},{1,3,3,0,0,0,1,1,0,4,0,4,0,0,1},
		{1,3,3,1,0,0,1,1,0,1,1,1,1,1,1},{1,3,3,1,0,1,0,4,0,4,0,1,0,0,0},{1,3,3,0,0,0,0,0,4,0,0,1,0,0,0},{1,0,0,1,1,1,5,0,0,1,1,1,0,0,0},
		{1,1,1,1,0,1,1,1,1,1,0,0,0,0,0}
	},
	{
		{0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0},{1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0},{1,0,0,4,0,4,0,1,0,1,1,1,1,1,1,1},
		{1,0,0,0,4,0,0,1,0,1,7,3,7,3,7,1},{1,1,0,4,0,4,0,1,1,1,3,7,3,7,3,1},{0,1,4,0,4,0,0,1,0,0,7,3,7,3,7,1},{0,1,5,4,0,4,0,0,0,0,3,7,3,7,1,1},
		{0,1,4,0,4,0,0,1,0,0,7,3,7,3,7,1},{1,1,0,4,0,4,0,1,1,1,3,7,3,7,3,1},{1,0,0,0,4,0,0,1,0,1,7,3,7,3,7,1},
		{1,0,0,4,0,4,0,1,0,1,1,1,1,1,1,1},{1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0},{0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0}
	},
	{
		{1,1,1,1,1,1,1,1,0},{1,3,3,3,3,3,3,1,0},{1,0,0,4,0,1,0,1,1},{1,0,4,0,1,0,4,0,1},{1,1,4,0,4,0,4,0,1},
		{0,1,0,0,5,0,0,0,1},{0,1,1,1,1,1,1,1,1}
	},
	{
		{0,0,1,1,1,1,1,1,1,1,1,1},{1,1,1,0,0,0,3,4,5,0,0,1},{1,0,0,0,1,1,4,1,1,0,0,1},{1,0,0,0,7,0,3,0,3,0,1,1},
		{1,1,0,4,1,1,4,1,1,0,1,0},{0,1,0,0,0,0,3,0,0,0,1,0},{0,1,1,1,1,1,1,1,1,1,1,0}
	},
	{
		 {0,0,0,1,1,1,1,1,1},{1,1,1,1,3,0,0,5,1},{1,0,0,4,4,4,0,0,1},{1,3,1,1,3,1,1,3,1},{1,0,0,0,4,0,0,0,1},
		 {1,0,0,4,3,1,0,1,1},{1,1,1,1,0,0,0,1,0},{0,0,0,1,1,1,1,1,0}
	},
	{
		 {0,1,1,1,1,1,1,0},{0,1,3,0,3,3,1,0},{0,1,3,0,4,3,1,0},{1,1,1,0,0,4,1,1},{1,0,4,0,0,4,0,1},
		 {1,0,1,4,1,1,0,1},{1,0,0,0,5,0,0,1},{1,1,1,1,1,1,1,1}
	},
	{
		{0,0,0,0,1,1,1,1,1,1,0,0,0,0},{0,0,1,1,1,0,0,0,0,1,1,1,0,0},{0,0,1,0,0,0,1,4,0,0,0,1,1,1},{0,0,1,0,0,0,4,0,0,0,4,4,0,1},
		{0,0,1,0,4,4,0,1,4,0,0,0,0,1},{0,0,1,1,0,0,0,4,0,0,0,4,0,1},{1,1,1,1,1,1,0,1,4,1,1,1,1,1},{1,3,3,5,0,1,4,0,0,1,0,0,0,0},
		{1,3,1,3,3,0,0,4,1,1,0,0,0,0},{1,3,3,3,3,4,1,0,1,0,0,0,0,0},{1,3,3,3,3,0,0,0,1,0,0,0,0,0},{1,1,1,1,1,1,1,1,1,0,0,0,0,0}
	},
	{
		{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},{1,0,0,0,0,0,0,1,0,0,0,0,0,0,1},{1,0,4,0,1,4,0,1,0,4,1,1,4,0,1},
		{1,0,1,0,0,4,0,1,0,0,0,0,0,0,1},{1,0,0,0,1,1,4,1,4,1,1,4,4,0,1},{1,0,1,0,1,0,3,3,3,0,1,0,0,0,1},{1,0,4,0,0,3,0,1,0,3,4,0,0,0,1},
		{1,0,4,1,5,4,3,3,3,1,0,1,0,0,1},{1,0,0,0,0,3,0,1,0,3,0,0,4,0,1},{1,0,1,1,3,4,1,1,1,4,3,0,1,0,1},{1,0,1,0,4,3,3,3,3,3,0,1,1,0,1},
		{1,0,0,0,0,0,0,0,0,0,0,0,0,0,1},{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,1,1,1,0},{1,0,0,0,1,1,0,0,1,0},{1,0,1,0,4,0,4,0,1,0},{1,0,0,7,3,1,0,0,1,0},{1,1,0,1,3,5,3,1,1,0},
		{1,1,4,1,1,1,7,1,1,1},{1,0,0,0,0,0,0,0,0,1},{1,0,0,0,1,1,0,1,0,1},{1,1,1,1,1,1,0,0,0,1},{0,0,0,0,0,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,1,1,0,0,0,0,0,0,0},{1,0,0,0,0,0,0,1,0,0,0,0,0,0,0},{1,0,4,4,0,0,0,1,1,1,0,0,0,0,0},
		{1,0,0,4,0,4,4,4,0,1,1,1,1,1,0},{1,1,0,1,1,0,3,3,3,0,0,0,0,1,1},{0,1,0,1,5,1,3,3,3,1,1,1,4,0,1},
		{0,1,0,1,0,4,3,3,3,0,0,0,0,0,1},{1,1,0,1,0,4,3,3,3,4,0,1,0,1,1},{1,0,0,1,1,1,1,1,0,1,1,1,0,1,0},
		{1,0,0,0,0,0,0,4,0,0,0,4,0,1,0},{1,1,1,1,1,1,1,1,1,1,1,0,0,1,0},{0,0,0,0,0,0,0,0,0,0,1,1,1,1,0}
	},
	{
		 {0,0,0,1,1,1,1,1,0},{0,0,0,1,0,5,0,1,0},{0,0,0,1,4,4,4,1,0},{1,1,1,1,0,0,0,1,0},{1,0,0,0,3,4,4,1,1},
		 {1,0,4,3,4,3,0,3,1},{1,0,0,1,3,1,3,1,1},{1,1,1,1,1,1,1,1,0}
	},
	{
		 {1,1,1,1,1,1,1,1,1,1,1,1},{1,3,3,3,0,1,0,0,0,0,0,1},{1,3,3,0,0,1,0,1,1,0,0,1},{1,3,3,0,0,0,0,0,1,0,0,1},
		 {1,3,3,0,0,1,0,4,1,1,0,1},{1,3,3,3,0,1,4,0,4,0,0,1},{1,1,1,1,1,1,0,0,4,4,0,1},{0,1,1,0,0,4,0,4,4,0,0,1},{0,1,5,0,4,4,4,0,0,1,0,1},
		 {0,1,1,0,4,0,1,1,0,0,0,1},{0,0,1,0,0,0,0,0,0,0,0,1},{0,0,1,1,1,1,1,1,1,1,1,1}
	},
	{
		 {1,1,1,1,1,1,1,1,1,0,0},{1,0,0,0,0,0,0,0,1,0,0},{1,0,0,4,0,4,0,4,1,0,0},{1,1,0,1,4,1,1,0,1,0,0},{0,1,0,3,3,0,3,3,1,1,0},
		 {0,1,1,3,3,0,3,3,0,1,0},{0,0,1,0,1,1,4,1,0,1,1},{0,0,1,4,0,4,0,4,0,0,1},{0,0,1,0,0,0,0,0,0,5,1},{0,0,1,1,1,1,1,1,1,1,1}
	},
	{
		{1,1,1,1,1,1,1},{1,3,0,3,0,3,1},{1,0,4,4,4,0,1},{1,3,4,5,4,3,1},{1,0,4,4,4,0,1},{1,3,0,3,0,3,1},{1,1,1,1,1,1,1}
	}
};





void currentMap();
void loadResoure();
void drawMap();
void keyDown();
void flushStdin();
void saveState(int r, int c, char dir);
void rollBack();
void gameMain();
void windowsMax();
struct attribute* storageAttribute(int x, int y, int width, int height, COLORREF color, const char* pText);
void drawLabel(int x, int y, COLORREF color, const char* text,int size);
void drawButton(struct attribute* pB);
int mouseInButton(struct attribute* pB, MOUSEMSG m);
int clickButton(struct attribute* pB, MOUSEMSG m);
void window();
void introduction();
void selectMap();
DWORD WINAPI timer(void* timerFlag);
void settlementWindow();
void changeLable();
void music();
void setMusic();
void setVolume();
void autoDir();
void setBoxMap(int px, int py, int prex, int prey);
void label();

void location();
bool Bound(int x, int y);
bool boxBound(int x, int y);
bool pbBound(int px, int py, int x, int y, int m, int n, int bx, int by);
int BFS();
void BFSdir();
